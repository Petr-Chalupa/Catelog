openapi: 3.1.0
info:
    title: Catelog API
    version: 1.0.0
servers:
    - url: /api
security:
    - bearerAuth: []

paths:
    /user/auth/login:
        post:
            summary: Authenticate with an external provider
            tags: [Auth]
            security: []
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            type: object
                            required: [token, provider]
                            properties:
                                token:
                                    type: string
                                provider:
                                    type: string
                                    enum: [google, microsoft]
            responses:
                200:
                    description: Successful authentication
                    content:
                        application/json:
                            schema:
                                type: object
                                properties:
                                    jwt:
                                        type: string
                                    user:
                                        $ref: "#/components/schemas/User"
                400:
                    description: Unsupported provider or invalid token

    /user/auth/refresh:
        post:
            summary: Exchange a refresh token for a new access token
            tags: [Auth]
            security: []
            responses:
                200:
                    description: New JWT issued
                    content:
                        application/json:
                            schema:
                                type: object
                                properties:
                                    jwt:
                                        type: string
                401: { $ref: "#/components/responses/UnauthorizedError" }

    /user/auth/logout:
        post:
            summary: Revoke the refresh token and clear cookies
            tags: [Auth]
            security: []
            responses:
                200:
                    description: Successfully logged out

    /user/me:
        get:
            summary: Get current authenticated user profile
            tags: [User]
            responses:
                200:
                    description: The authenticated user object
                    content:
                        application/json:
                            schema: { $ref: "#/components/schemas/User" }
                401: { $ref: "#/components/responses/UnauthorizedError" }
                404:
                    description: User not found
        patch:
            summary: Update user profile
            tags: [User]
            requestBody:
                content:
                    application/json:
                        schema:
                            type: object
                            properties:
                                name:
                                    type: string
                                email:
                                    type: string
            responses:
                200:
                    description: Profile updated
                    content:
                        application/json:
                            schema: { $ref: "#/components/schemas/User" }
                400:
                    description: No data provided for update
                401: { $ref: "#/components/responses/UnauthorizedError" }
                404:
                    description: User not found
        delete:
            summary: Delete user account and all connected data
            tags: [User]
            responses:
                200:
                    description: Account deleted successfully
                401: { $ref: "#/components/responses/UnauthorizedError" }
                500:
                    description: Unexpected error while deleting user data

    /titles:
        post:
            summary: Add a title to catalogue
            tags: [Titles]
            requestBody:
                required: true
                content:
                    application/json:
                        schema: { $ref: "#/components/schemas/Title" }
            responses:
                200:
                    description: Title added
                    content:
                        application/json:
                            schema: { $ref: "#/components/schemas/Title" }
                401: { $ref: "#/components/responses/UnauthorizedError" }
                500:
                    description: Unexpected error while inserting title

    /titles/{id}:
        get:
            summary: Get title by ID
            tags: [Titles]
            parameters:
                - name: id
                  in: path
                  required: true
                  schema:
                      type: string
            responses:
                200:
                    description: Title details
                    content:
                        application/json:
                            schema: { $ref: "#/components/schemas/Title" }
                401: { $ref: "#/components/responses/UnauthorizedError" }
                404:
                    description: Title not found

    /titles/search:
        get:
            summary: Search for a title in external sources
            tags: [Titles]
            parameters:
                - name: q
                  in: query
                  description: Search query (title name)
                  required: true
                  schema:
                      type: string
            responses:
                200:
                    description: List of matching titles
                    content:
                        application/json:
                            schema:
                                type: array
                                items: { $ref: "#/components/schemas/Title" }
                401: { $ref: "#/components/responses/UnauthorizedError" }
                500:
                    description: Search failed

    /watchlists:
        get:
            summary: Get all user watchlists
            tags: [WatchLists]
            responses:
                200:
                    description: WatchLists
                    content:
                        application/json:
                            schema:
                                type: array
                                items: { $ref: "#/components/schemas/WatchList" }
                401: { $ref: "#/components/responses/UnauthorizedError" }
                403: { $ref: "#/components/responses/ForbiddenError" }
        post:
            summary: Create a new watchlist
            tags: [WatchLists]
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            type: object
                            required: [name]
                            properties:
                                name:
                                    type: string
            responses:
                200:
                    description: WatchList created
                    content:
                        application/json:
                            schema: { $ref: "#/components/schemas/WatchList" }
                401: { $ref: "#/components/responses/UnauthorizedError" }
                403: { $ref: "#/components/responses/ForbiddenError" }
                500:
                    description: Unexpected error while creating watchlist

    /watchlists/{listId}:
        get:
            summary: Get watchlist by ID
            tags: [WatchLists]
            parameters:
                - name: listId
                  in: path
                  required: true
                  schema:
                      type: string
            responses:
                200:
                    description: WatchList
                    content:
                        application/json:
                            schema: { $ref: "#/components/schemas/WatchList" }
                401: { $ref: "#/components/responses/UnauthorizedError" }
                403: { $ref: "#/components/responses/ForbiddenError" }
        patch:
            summary: Update watchlist details
            tags: [WatchLists]
            parameters:
                - name: listId
                  in: path
                  required: true
                  schema:
                      type: string
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            type: object
                            properties:
                                name:
                                    type: string
                                sharedWith:
                                    type: array
                                    items:
                                        type: string
            responses:
                200:
                    description: WatchList updated
                    content:
                        application/json:
                            schema: { $ref: "#/components/schemas/WatchList" }
                400:
                    description: No data provided for update
                401: { $ref: "#/components/responses/UnauthorizedError" }
                403: { $ref: "#/components/responses/ForbiddenError" }
                404:
                    description: WatchList not found
        delete:
            summary: Delete a specific watchlist or transfer ownership
            tags: [WatchLists]
            parameters:
                - name: listId
                  in: path
                  required: true
                  schema:
                      type: string
            responses:
                200:
                    description: WatchList processed successfully
                401: { $ref: "#/components/responses/UnauthorizedError" }
                403: { $ref: "#/components/responses/ForbiddenError" }
                404:
                    description: WatchList not found
                500:
                    description: Unexpected error while deleting watchlist

    /watchlists/{listId}/items:
        get:
            summary: Get items in a watchlist
            tags: [WatchLists]
            parameters:
                - name: watchlistId
                  in: path
                  required: true
                  schema:
                      type: string
            responses:
                200:
                    description: WatchList items
                    content:
                        application/json:
                            schema:
                                type: object
                                properties:
                                    items:
                                        type: array
                                        items: { $ref: "#/components/schemas/WatchListItem" }
                403: { $ref: "#/components/responses/ForbiddenError" }
                404:
                    description: WatchList not found
        post:
            summary: Add item to watchlist
            tags: [WatchLists]
            parameters:
                - name: listId
                  in: path
                  required: true
                  schema:
                      type: string
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            type: object
                            required: [titleId]
                            properties:
                                titleId:
                                    type: string
            responses:
                200:
                    description: Item added
                    content:
                        application/json:
                            schema: { $ref: "#/components/schemas/WatchListItem" }
                400:
                    description: No data provided for update
                401: { $ref: "#/components/responses/UnauthorizedError" }
                403: { $ref: "#/components/responses/ForbiddenError" }
                404:
                    description: WatchList not found

    /watchlists/{listId}/items/{itemId}:
        patch:
            summary: Update watchlist item
            tags: [WatchLists]
            parameters:
                - name: listId
                  in: path
                  required: true
                  schema:
                      type: string
                - name: itemId
                  in: path
                  required: true
                  schema:
                      type: string
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            type: object
                            properties:
                                state:
                                    type: string
                                    enum: [planned, started, finished]
                                tags:
                                    type: array
                                    items:
                                        type: string
                                personalRating:
                                    type: number
            responses:
                200:
                    description: Item updated
                401: { $ref: "#/components/responses/UnauthorizedError" }
                403: { $ref: "#/components/responses/ForbiddenError" }
                404:
                    description: WatchList or watchlist item not found
        delete:
            summary: Remove item from watchlist
            tags: [WatchLists]
            parameters:
                - name: listId
                  in: path
                  required: true
                  schema:
                      type: string
                - name: itemId
                  in: path
                  required: true
                  schema:
                      type: string
            responses:
                200:
                    description: Item removed
                401: { $ref: "#/components/responses/UnauthorizedError" }
                403: { $ref: "#/components/responses/ForbiddenError" }
                404:
                    description: WatchList or watchlist item not found

    /watchlists/{listId}/invites:
        post:
            summary: Create invite to watchlist
            tags: [Invites]
            parameters:
                - name: listId
                  in: path
                  required: true
                  schema:
                      type: string
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            type: object
                            properties:
                                inviteeId:
                                    type: string
            responses:
                200:
                    description: Invite created
                    content:
                        application/json:
                            schema: { $ref: "#/components/schemas/Invite" }
                401: { $ref: "#/components/responses/UnauthorizedError" }
                403: { $ref: "#/components/responses/ForbiddenError" }
                404:
                    description: WatchList not found
                500:
                    description: Unexpected error while creating invite

    /watchlists/invites/{token}/accept:
        post:
            summary: Accept watchlist invite
            tags: [Invites]
            parameters:
                - name: token
                  in: path
                  required: true
                  schema:
                      type: string
            responses:
                200:
                    description: Invite accepted
                400:
                    description: Invite expired
                401: { $ref: "#/components/responses/UnauthorizedError" }
                403: { $ref: "#/components/responses/ForbiddenError" }
                404:
                    description: Invite or related watchList not found

components:
    securitySchemes:
        bearerAuth:
            type: http
            scheme: bearer
            bearerFormat: JWT

    responses:
        ValidationError: # 400
            description: Request body or parameters failed validation
            content:
                application/json:
                    schema:
                        type: object
                        properties:
                            message:
                                type: string
                            errors:
                                type: array
                                items:
                                    type: object

        UnauthorizedError: # 401
            description: Access token is missing or invalid
            content:
                application/json:
                    schema:
                        type: object
                        properties:
                            message:
                                type: string

        ForbiddenError: # 403
            description: The authenticated user does not have permission to access this resource
            content:
                application/json:
                    schema:
                        type: object
                        properties:
                            message:
                                type: string

    schemas:
        Title:
            type: object
            required: [id, type, title, public, externalIds]
            properties:
                id:
                    type: string
                    format: uuid
                type:
                    type: string
                    enum: [movie, series]
                title:
                    type: string
                localizedTitles:
                    type: object
                    additionalProperties:
                        type: string
                poster:
                    type: string
                year:
                    type: integer
                genres:
                    type: array
                    items:
                        type: string
                        enum:
                            [
                                action,
                                adventure,
                                comedy,
                                drama,
                                fantasy,
                                horror,
                                history,
                                sci_fi,
                                romance,
                                thriller,
                                animation,
                                documentary,
                                crime,
                                mystery,
                                family,
                                musical,
                            ]
                ratings:
                    type: object
                    additionalProperties:
                        type: number
                avgRating:
                    type: number
                directors:
                    type: array
                    items:
                        type: string
                actors:
                    type: array
                    items:
                        type: string
                durationMinutes:
                    type: integer
                externalIds:
                    type: object
                    additionalProperties:
                        type: string
                mergeCandidates:
                    type: object
                    additionalProperties:
                        type: string
                public:
                    type: boolean
                createdAt:
                    type: string
                    format: date-time
                updatedAt:
                    type: string
                    format: date-time

        WatchList:
            type: object
            required: [id, name, ownerId, sharedWith, createdAt]
            properties:
                id:
                    type: string
                    format: uuid
                name:
                    type: string
                ownerId:
                    type: string
                sharedWith:
                    type: array
                    items:
                        type: string
                createdAt:
                    type: string
                    format: date-time

        WatchListItem:
            type: object
            required: [id, listId, titleId, state, addedBy, createdAt]
            properties:
                id:
                    type: string
                    format: uuid
                listId:
                    type: string
                titleId:
                    type: string
                state:
                    type: string
                    enum: [planned, started, finished]
                tags:
                    type: array
                    items:
                        type: string
                personalRating:
                    type: number
                addedBy:
                    type: string
                createdAt:
                    type: string
                    format: date-time
                updatedAt:
                    type: string
                    format: date-time

        User:
            type: object
            required: [id, email, createdAt]
            properties:
                id:
                    type: string
                    format: uuid
                email:
                    type: string
                    format: email
                name:
                    type: string
                createdAt:
                    type: string
                    format: date-time

        Invite:
            type: object
            required: [id, listId, inviter, invitee, token, expiresAt, createdAt]
            properties:
                id:
                    type: string
                    format: uuid
                listId:
                    type: string
                inviter:
                    type: string
                invitee:
                    type: string
                token:
                    type: string
                expiresAt:
                    type: string
                    format: date-time
                createdAt:
                    type: string
                    format: date-time
